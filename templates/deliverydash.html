<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Delivery Dash üöó</title>

    <style>
        :root {
            --bg: #0c0c0c;
            --accent: #00ff99;
            --accent-strong: #30ef99;
            --danger: #ff4040;
        }

        * {
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            background: var(--bg);
            color: var(--accent);
            font-family: 'Press Start 2P', monospace;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            overflow-x: hidden;
            overflow-y: hidden;
            flex-direction: column;
        }

        #hud {
            position: fixed;
            top: 12px;
            left: 50%;
            transform: translateX(-50%);
            color: var(--accent);
            font-size: 18px;
            z-index: 40;
            pointer-events: none;
            /* n√£o bloqueia toques */
            white-space: nowrap;
        }

        #gameWrapper {
            width: 100%;
            max-width: 1000px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
            padding: 24px;
            position: relative;
        }

        #gameContainer {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
        }

        canvas {
            display: block;
            background: var(--bg);
            border: 4px solid var(--accent-strong);
            max-width: 100%;
            width: min(800px, 90vw);
            /* responsivo: cresce at√© 800px */
            height: auto;
            border-radius: 6px;
            box-shadow: 0 6px 20px rgba(60, 255, 0, 0.6);
            touch-action: manipulation;
        }

        #countdown,
        #gameOver {
            position: absolute;
            left: 50%;
            transform: translate(-50%, -50%);
            top: 50%;
            text-align: center;
            z-index: 30;
            pointer-events: none;
        }

        #countdown {
            font-size: 60px;
            color: var(--accent);
        }

        #gameOver {
            display: none;
            font-size: 20px;
            color: var(--danger);
        }

        #controls {
            margin-top: 6px;
            display: grid;
            grid-template-columns: repeat(3, 80px);
            grid-template-rows: 80px 80px;
            gap: 10px;
            justify-content: center;
            align-items: center;
            user-select: none;
            z-index: 20;
        }

        .btn {
            width: 80px;
            height: 80px;
            background: rgba(0, 255, 153, 0.15);
            border: 2px solid var(--accent);
            border-radius: 50%;
            color: var(--accent);
            font-size: 26px;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: transform .08s ease, background .08s ease;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }

        .btn:active {
            background: rgba(0, 255, 153, 0.4);
            transform: scale(0.94);
        }

        @media (max-width: 768px) {
            #hud {
                font-size: 14px;
                top: 8px;
            }

            #countdown {
                font-size: 40px;
            }

            #gameOver {
                font-size: 16px;
            }

            canvas {
                width: 92vw;
                border-width: 3px;
            }

            #controls {
                grid-template-columns: 70px 70px 70px;
                grid-template-rows: 70px 70px;
                gap: 8px;
                margin-top: 8px;
            }

            .btn {
                width: 60px;
                height: 60px;
                font-size: 20px;
            }
        }

        @media (min-width: 769px) {
            canvas {
                width: 550px !important;
                max-width: 65vw !important;
            }
        }

        @media (min-width: 1025px) {
            #controls {
                display: none !important;
            }
        }

        @media (max-height: 420px) {
            #gameWrapper {
                padding-top: 48px;
                padding-bottom: 8px;
            }

            #hud {
                top: 6px;
            }

            #controls {
                margin-top: 4px;
            }
        }
    </style>
</head>

<body>

    <!-- MUSICA DE FUNDO -->
    <audio id="bgMusic" loop muted>
        <source src="../static/audio/Helios.mp3" type="audio/mpeg">
    </audio>

    <!-- SONS DE EFEITOS -->
    <audio id="s_hit" preload="auto">
        <source src="../static/audio/hit.mp3" type="audio/mpeg">
    </audio>
    <audio id="s_coin" preload="auto">
        <source src="../static/audio/coin.mp3" type="audio/mpeg">
    </audio>
    <audio id="s_magnet" preload="auto">
        <source src="../static/audio/magnet.mp3" type="audio/mpeg">
    </audio>
    <audio id="s_heart" preload="auto">
        <source src="../static/audio/heart.mp3" type="audio/mpeg">
    </audio>
    <audio id="s_shield" preload="auto">
        <source src="../static/audio/shield.mp3" type="audio/mpeg">
    </audio>
    <audio id="s_gameover" preload="auto">
        <source src="../static/audio/gameover.mp3" type="audio/mpeg">
    </audio>
    <audio id="s_start" preload="auto">
        <source src="../static/audio/start.mp3" type="audio/mpeg">
    </audio>


    <div id="hud">Velocidade: <span id="speed">0</span> | Pontos: <span id="score">0</span> | Vidas: <span
            id="lives">3</span></div>
    <div id="gameOver">üöó GAME OVER üöó<br><small>Pressione R para reiniciar</small></div>
    <div id="countdown"></div>

    <div id="gameWrapper">
        <canvas id="gameCanvas" width="480" height="550"></canvas>
    </div>

    <div id="controls">
        <div></div>
        <div class="btn" data-dir="up">‚ñ≤</div>
        <div></div>
        <div class="btn" data-dir="left">‚óÄ</div>
        <div class="btn" data-dir="down">‚ñº</div>
        <div class="btn" data-dir="right">‚ñ∂</div>
    </div>

    <button id="pauseBtn" style="
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 12px 18px;
    background: #ffcc00;
    border: none;
    border-radius: 8px;
    font-size: 18px;
    font-weight: bold;
    cursor: pointer;
">‚è∏</button>

    <script>
        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");

        ctx.textBaseline = 'top';
        ctx.textAlign = 'left';

        const speedDisplay = document.getElementById("speed");
        const scoreDisplay = document.getElementById("score");
        const livesDisplay = document.getElementById("lives");
        const countdownEl = document.getElementById("countdown");

        /* ---------------------------
            √Åudio de fundo & efeitos
        --------------------------- */
        const bgMusic = document.getElementById("bgMusic");
        bgMusic.volume = 0.6;

        const s_hit = document.getElementById("s_hit");
        const s_coin = document.getElementById("s_coin");
        const s_magnet = document.getElementById("s_magnet");
        const s_heart = document.getElementById("s_heart");
        const s_shield = document.getElementById("s_shield");
        const s_gameover = document.getElementById("s_gameover");
        const s_start = document.getElementById("s_start");

        // flag para saber se j√° tivemos intera√ß√£o que desbloqueou √°udio
        let audioUnlocked = false;

        // Fun√ß√£o que tenta "desbloquear" todos os √°udios no primeiro gesto do usu√°rio
        function unlockAllAudio() {
            if (audioUnlocked) return;
            audioUnlocked = true;

            // desmuta e tenta tocar bgMusic
            try {
                bgMusic.muted = false;
                bgMusic.play().catch(() => { /* ignorar */ });
            } catch (e) { /* ignorar */ }

            // Para desbloquear efeitos, tocamos rapidamente cada som (play -> pause).
            // Isso deve ser chamado durante uma intera√ß√£o do usu√°rio (evento de clique/tecla/toque).
            const effects = [s_hit, s_coin, s_magnet, s_heart, s_shield, s_gameover, s_start];
            effects.forEach(a => {
                if (!a) return;
                try {
                    // alguns navegadores permitem tocar depois de uma intera√ß√£o; tocamos e pausamos.
                    a.currentTime = 0;
                    const p = a.play();
                    if (p && p.then) {
                        p.then(() => { a.pause(); a.currentTime = 0; }).catch(() => { /* bloqueado */ });
                    }
                } catch (err) { /* ignorar */ }
            });
        }

        // helper para tocar sons de forma que m√∫ltiplas inst√¢ncias possam sobrepor
        function playSound(audioEl) {
            if (!audioEl) return;
            try {
                // clonamos o elemento para permitir sobreposi√ß√£o (ex.: v√°rios hits seguidos)
                const cloned = audioEl.cloneNode(true);
                cloned.muted = false;
                cloned.volume = audioEl.volume ?? 1.0;
                // toca sem aguardar erro (se estiver bloqueado, falhar√° silenciosamente)
                cloned.play().catch(() => { /* se bloquear, ignora */ });
            } catch (e) {
                // fallback: tentar tocar o pr√≥prio elemento (pode cortar som anterior)
                try { audioEl.play().catch(() => { }); } catch (err) { }
            }
        }

        // liga handlers para primeiro gesto do usu√°rio
        function firstInteractionHandler() {
            unlockAllAudio();
            window.removeEventListener("mousedown", firstInteractionHandler);
            window.removeEventListener("touchstart", firstInteractionHandler);
            window.removeEventListener("keydown", firstInteractionHandler);
        }
        window.addEventListener("mousedown", firstInteractionHandler, { once: true });
        window.addEventListener("touchstart", firstInteractionHandler, { once: true });
        window.addEventListener("keydown", firstInteractionHandler, { once: true });

        /* ---------------------------
            Vari√°veis do jogo
        --------------------------- */
        let roadSpeed = 3, acceleration = 0.0003, playerSpeed = 5;
        let playerX = canvas.width / 2 - 20, playerY = canvas.height - 120;
        const roadWidth = 300, laneCount = 4, laneWidth = roadWidth / laneCount;
        let roadLines = [], keys = {}, score = 0, lives = 3;
        let obstacles = [], foods = [], magnets = [], hearts = [], shields = [], popups = [];
        let magnetActive = false, magnetTimer = 0, shieldActive = false, shieldTimer = 0;
        let gameOver = false, gameStarted = false;

        // inatividade: zerar pontua√ß√£o ap√≥s X frames
        let inactivityTimer = 0, inactivityLimit = 480;
        function punishInactivity() { score = 0; updateScoreDisplay(); createPopup("- Pontos zerados", player.x, player.y - 20); playSound(s_hit /* efeito discreto para feedback */); }

        const player = { x: playerX, y: playerY, w: 20, h: 35, color: "#00ff99" };

        const obstacleTypes = [
            { emoji: "üöß", w: 25, h: 25 },
            { emoji: "üöß", w: 25, h: 25 },
            { emoji: "üöß", w: 25, h: 25 }
        ];

        // pontos reduzidos conforme seu pedido
        const foodTypes = [
            { emoji: "üçî", w: 30, h: 30, points: 5 },
            { emoji: "üçï", w: 30, h: 30, points: 10 }
        ];

        const magnetType = { emoji: "üß≤", w: 30, h: 30 };
        const heartType = { emoji: "ü§ç", w: 30, h: 30 };
        const shieldType = { emoji: "üõ°Ô∏è", w: 30, h: 30 };
        const obstaclePenalty = 150; // penalidade ao bater em obst√°culo

        /* ---------------------------
            Popups
        --------------------------- */
        function drawPopups() {
            ctx.font = "20px Arial";
            ctx.fillStyle = "#00ff99";
            for (let i = popups.length - 1; i >= 0; i--) {
                const p = popups[i];
                ctx.globalAlpha = p.alpha;
                ctx.fillText(p.text, p.x - (p.text.length * 3.5), p.y);
                p.y -= 1.2;
                p.alpha -= 0.02;
                if (p.alpha <= 0) popups.splice(i, 1);
            }
            ctx.globalAlpha = 1;
        }

        function createPopup(text, x, y) { popups.push({ text, x, y, alpha: 1 }); }

        /* ---------------------------
            Util
        --------------------------- */
        function clampScore() { if (score < 0) score = 0; }
        function updateScoreDisplay() { clampScore(); scoreDisplay.textContent = Math.floor(score); }
        function collides(a, b) { return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y; }

        function safeSpawn(list, obj) {
            const allLists = [obstacles, foods, magnets, hearts, shields];
            for (let arr of allLists) for (let item of arr) if (collides(obj, item)) return false;
            list.push(obj);
            return true;
        }

        /* ---------------------------
            Spawn de objetos
        --------------------------- */
        function spawnObstacle() {
            if (Math.random() < 0.02) {
                const lane = Math.floor(Math.random() * laneCount);
                const roadX = canvas.width / 2 - roadWidth / 2;
                const type = obstacleTypes[Math.floor(Math.random() * obstacleTypes.length)];
                const obj = { ...type, x: roadX + lane * laneWidth + laneWidth / 2 - type.w / 2, y: -50 };
                safeSpawn(obstacles, obj);
            }
        }

        function spawnFood() {
            if (Math.random() < 0.015) {
                const lane = Math.floor(Math.random() * laneCount);
                const roadX = canvas.width / 2 - roadWidth / 2;
                const type = foodTypes[Math.floor(Math.random() * foodTypes.length)];
                const obj = { ...type, x: roadX + lane * laneWidth + laneWidth / 2 - type.w / 2, y: -50 };
                safeSpawn(foods, obj);
            }
        }

        function spawnMagnet() {
            if (Math.random() < 0.0002) {
                const lane = Math.floor(Math.random() * laneCount);
                const roadX = canvas.width / 2 - roadWidth / 2;
                const obj = { ...magnetType, x: roadX + lane * laneWidth + laneWidth / 2 - magnetType.w / 2, y: -50 };
                safeSpawn(magnets, obj);
            }
        }

        function spawnHeart() {
            if (Math.random() < 0.0001) {
                const lane = Math.floor(Math.random() * laneCount);
                const roadX = canvas.width / 2 - roadWidth / 2;
                const obj = { ...heartType, x: roadX + lane * laneWidth + laneWidth / 2 - heartType.w / 2, y: -50 };
                safeSpawn(hearts, obj);
            }
        }

        function spawnShield() {
            if (Math.random() < 0.0002) {
                const lane = Math.floor(Math.random() * laneCount);
                const roadX = canvas.width / 2 - roadWidth / 2;
                const obj = { ...shieldType, x: roadX + lane * laneWidth + laneWidth / 2 - shieldType.w / 2, y: -50 };
                safeSpawn(shields, obj);
            }
        }

        /* ---------------------------
            Input
        --------------------------- */
        window.addEventListener("keydown", (e) => {
            keys[e.key] = true;
            if (["ArrowLeft", "ArrowRight", "left", "right"].includes(e.key)) inactivityTimer = 0;
        });
        window.addEventListener("keyup", (e) => keys[e.key] = false);
        window.addEventListener("keydown", (e) => { if (e.key === "r" || e.key === "R") restartGame(); });

        document.querySelectorAll('.btn').forEach(btn => {
            btn.addEventListener('touchstart', (ev) => { ev.preventDefault(); keys[btn.dataset.dir] = true; if (btn.dataset.dir === "left" || btn.dataset.dir === "right") inactivityTimer = 0; });
            btn.addEventListener('touchend', (ev) => { ev.preventDefault(); keys[btn.dataset.dir] = false; });
            btn.addEventListener('mousedown', () => { keys[btn.dataset.dir] = true; if (btn.dataset.dir === "left" || btn.dataset.dir === "right") inactivityTimer = 0; });
            btn.addEventListener('mouseup', () => { keys[btn.dataset.dir] = false; });
        });

        for (let i = 0; i < 20; i++) roadLines.push({ x: canvas.width / 2, y: i * 40 });

        /* ---------------------------
            Loop principal
        --------------------------- */
        function drawList(list) {
            ctx.font = "28px Arial";
            list.forEach(o => { ctx.fillText(o.emoji, o.x, o.y + o.h); o.y += roadSpeed; });
            return list.filter(o => o.y < canvas.height + 50);
        }

        function drawCar(p) {
            ctx.fillStyle = "#00ff99";
            ctx.fillRect(p.x, p.y, p.w, p.h);
            ctx.fillStyle = "#002200";
            ctx.fillRect(p.x + 4, p.y + 8, p.w - 8, 12);
            ctx.fillRect(p.x + 4, p.y + p.h - 20, p.w - 8, 12);
            ctx.fillStyle = "#ffff66";
            ctx.fillRect(p.x + 3, p.y, 6, 6);
            ctx.fillRect(p.x + p.w - 9, p.y, 6, 6);
            ctx.fillStyle = "#000";
            ctx.fillRect(p.x - 4, p.y + 8, 6, 15);
            ctx.fillRect(p.x + p.w - 2, p.y + 8, 6, 15);
            ctx.fillRect(p.x - 4, p.y + p.h - 25, 6, 15);
            ctx.fillRect(p.x + p.w - 2, p.y + p.h - 25, 6, 15);
            if (shieldActive) { ctx.strokeStyle = "#00aaff"; ctx.lineWidth = 4; ctx.beginPath(); ctx.arc(p.x + p.w / 2, p.y + p.h / 2, 35, 0, Math.PI * 2); ctx.stroke(); }
        }

        function checkCollision() {
            for (let i = obstacles.length - 1; i >= 0; i--) {
                let o = obstacles[i];
                if (collides(player, o)) {
                    obstacles.splice(i, 1);
                    if (!shieldActive) {
                        lives--; livesDisplay.textContent = lives;
                        score -= obstaclePenalty; if (score < 0) score = 0;
                        createPopup("-" + obstaclePenalty, player.x, player.y - 20);
                        playSound(s_hit);
                        updateScoreDisplay();
                        if (lives <= 0) {
                            gameOver = true;
                            playSound(s_gameover);
                            // mostra alert e reinicia quando o jogador apertar OK
                            setTimeout(() => {
                                try { alert("GAME OVER ‚Äî Aperte OK para reiniciar"); } catch (e) { /* ignore */ }
                                restartGame();
                            }, 120);
                        }
                    } else {
                        playSound(s_hit);
                    }
                }
            }
        }

        function checkFoodCollection() {
            for (let i = foods.length - 1; i >= 0; i--) {
                let f = foods[i];
                if (collides(player, f)) {
                    score += f.points;
                    createPopup("+" + f.points, f.x, f.y);
                    foods.splice(i, 1);
                    playSound(s_coin);
                    updateScoreDisplay();
                    continue;
                }
                if (magnetActive) { let dx = player.x - f.x, dy = player.y - f.y; let dist = Math.sqrt(dx * dx + dy * dy); if (dist < 150) { f.x += dx / 12; f.y += dy / 12; } }
            }
        }

        function checkMagnetCollection() { for (let i = magnets.length - 1; i >= 0; i--) if (collides(player, magnets[i])) { magnets.splice(i, 1); magnetActive = true; magnetTimer = 600; playSound(s_magnet); } }
        function checkHeartCollection() { for (let i = hearts.length - 1; i >= 0; i--) if (collides(player, hearts[i])) { hearts.splice(i, 1); lives++; livesDisplay.textContent = lives; playSound(s_heart); } }
        function checkShieldCollection() { for (let i = shields.length - 1; i >= 0; i--) if (collides(player, shields[i])) { shields.splice(i, 1); shieldActive = true; shieldTimer = 600; playSound(s_shield); } }

        function draw() {
            if (!gameStarted) return;
            if (paused) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const roadX = canvas.width / 2 - roadWidth / 2;
            ctx.fillStyle = "#333"; ctx.fillRect(roadX, 0, roadWidth, canvas.height);
            ctx.fillStyle = "#888"; ctx.fillRect(roadX - 20, 0, 20, canvas.height); ctx.fillRect(roadX + roadWidth, 0, 20, canvas.height);
            ctx.strokeStyle = "#fff"; ctx.lineWidth = 3; ctx.setLineDash([20, 20]);
            for (let i = 1; i < laneCount; i++) { const lineX = roadX + i * laneWidth; ctx.beginPath(); ctx.moveTo(lineX, 0); ctx.lineTo(lineX, canvas.height); ctx.stroke(); }
            ctx.setLineDash([]);
            roadLines.forEach(rl => { ctx.strokeStyle = "#fff"; ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(rl.x, rl.y); ctx.lineTo(rl.x, rl.y + 20); ctx.stroke(); rl.y += roadSpeed; if (rl.y > canvas.height) rl.y = -20; });

            // movimento e detec√ß√£o de "moved" para inatividade
            let moved = false;
            if (keys.ArrowLeft || keys.left) { player.x -= playerSpeed; moved = true; }
            if (keys.ArrowRight || keys.right) { player.x += playerSpeed; moved = true; }
            if (keys.ArrowUp || keys.up) player.y -= playerSpeed;
            if (keys.ArrowDown || keys.down) player.y += playerSpeed;

            if (player.x < roadX) player.x = roadX; if (player.x + player.w > roadX + roadWidth) player.x = roadX + roadWidth - player.w;
            if (player.y < 0) player.y = 0; if (player.y + player.h > canvas.height) player.y = canvas.height - player.h;

            drawList(obstacles); drawList(foods); drawList(magnets); drawList(hearts); drawList(shields);
            drawCar(player); drawPopups();

            checkCollision(); checkFoodCollection(); checkMagnetCollection(); checkHeartCollection(); checkShieldCollection();

            if (magnetActive) { magnetTimer--; if (magnetTimer <= 0) magnetActive = false; }
            if (shieldActive) { shieldTimer--; if (shieldTimer <= 0) shieldActive = false; }

            roadSpeed += acceleration;
            // exibi√ß√£o de velocidade simplificada
            speedDisplay.textContent = Math.floor(roadSpeed * 10);
            // b√¥nus de pontua√ß√£o por tempo reduzido (mantive pequeno ganho)
            score += 0.01;
            updateScoreDisplay();

            spawnObstacle(); spawnFood(); spawnMagnet(); spawnHeart(); spawnShield();

            // inatividade
            if (moved) inactivityTimer = 0; else { inactivityTimer++; if (inactivityTimer >= inactivityLimit) { punishInactivity(); inactivityTimer = 0; } }

            if (!gameOver) requestAnimationFrame(draw);
        }

        let paused = false;
        const pauseBtn = document.getElementById("pauseBtn");

        pauseBtn.addEventListener("click", () => {
            paused = !paused;

            if (paused) {
                pauseBtn.textContent = "‚ñ∂";
            } else {
                pauseBtn.textContent = "‚è∏";
                requestAnimationFrame(draw);
            }
        });
        function startCountdown() {
            let count = 3;
            countdownEl.textContent = count;
            const interval = setInterval(() => {
                count--;
                if (count > 0) { countdownEl.textContent = count; playSound(s_start); }
                else {
                    clearInterval(interval);
                    countdownEl.style.display = "none";
                    gameStarted = true;
                    draw();
                }
            }, 1000);
        }

        function restartGame() {
            score = 0; roadSpeed = 3; player.x = canvas.width / 2 - 20; player.y = canvas.height - 120;
            obstacles = []; foods = []; magnets = []; hearts = []; shields = []; popups = [];
            magnetActive = shieldActive = false; magnetTimer = shieldTimer = 0; lives = 3; gameOver = false;
            updateScoreDisplay(); livesDisplay.textContent = lives;
            countdownEl.style.display = "block"; inactivityTimer = 0; startCountdown();
        }

        startCountdown();
    </script>

</body>

</html>